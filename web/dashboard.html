<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HWK QIP Incentive Dashboard</title>

    <!-- CDN: Bootstrap 5.3.2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- CDN: Font Awesome 6.4.0 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* ===== Global & Reset ===== */
        :root {
            --header-dark: #1a237e;
            --header-light: #283593;
            --accent: #448aff;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --bg-light: #f5f7fa;
            --text-primary: #212121;
            --text-secondary: #757575;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-light); color: var(--text-primary); margin: 0; }

        /* ===== Loading Overlay ===== */
        #loading-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(255,255,255,0.92);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { width: 48px; height: 48px; border: 5px solid #e0e0e0; border-top-color: var(--header-dark); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loading-overlay p { margin-top: 16px; font-size: 1.1rem; color: var(--text-secondary); }

        /* ===== Error Message ===== */
        #error-message { display: none; max-width: 600px; margin: 80px auto; padding: 24px; background: #fff; border-left: 4px solid var(--danger); border-radius: 8px; box-shadow: var(--card-shadow); }
        #error-message h4 { color: var(--danger); margin: 0 0 8px; }

        /* ===== Header ===== */
        .dashboard-header {
            background: linear-gradient(135deg, var(--header-dark), var(--header-light));
            color: #fff; padding: 16px 24px;
            display: flex; flex-wrap: wrap; align-items: center; gap: 12px;
        }
        .dashboard-header .title-section { flex: 1; min-width: 200px; }
        .dashboard-header h1 { font-size: 1.35rem; margin: 0; font-weight: 700; }
        .dashboard-header .meta { font-size: 0.8rem; opacity: 0.85; margin-top: 2px; }
        .header-controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .lang-btn { padding: 4px 10px; border: 1px solid rgba(255,255,255,0.5); border-radius: 4px; background: transparent; color: #fff; cursor: pointer; font-size: 0.75rem; transition: background 0.2s; }
        .lang-btn:hover, .lang-btn.active { background: rgba(255,255,255,0.25); }
        .header-link { color: rgba(255,255,255,0.85); text-decoration: none; font-size: 0.8rem; padding: 4px 8px; }
        .header-link:hover { color: #fff; }
        .btn-logout { padding: 4px 12px; border: 1px solid rgba(255,255,255,0.5); border-radius: 4px; background: transparent; color: #fff; cursor: pointer; font-size: 0.78rem; }
        .btn-logout:hover { background: rgba(255,255,255,0.2); }
        .user-email { font-size: 0.75rem; opacity: 0.8; }

        /* ===== Tab Navigation ===== */
        .tabs {
            display: flex; overflow-x: auto; background: #fff;
            border-bottom: 2px solid #e0e0e0; padding: 0 16px;
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .tabs::-webkit-scrollbar { display: none; }
        .tab {
            padding: 12px 18px; cursor: pointer; white-space: nowrap;
            font-size: 0.88rem; color: var(--text-secondary);
            border-bottom: 3px solid transparent; transition: all 0.2s;
            user-select: none;
        }
        .tab:hover { color: var(--header-dark); background: #f0f4ff; }
        .tab.active { color: var(--header-dark); border-bottom-color: var(--header-dark); font-weight: 600; }

        /* ===== Tab Content ===== */
        .tab-content { display: none; padding: 20px; max-width: 1400px; margin: 0 auto; }
        .tab-content.active-tab { display: block; }

        /* ===== KPI Cards ===== */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .kpi-card {
            background: #fff; border-radius: 12px; padding: 20px;
            box-shadow: var(--card-shadow); text-align: center; position: relative; overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .kpi-card .kpi-icon { font-size: 1.6rem; margin-bottom: 6px; }
        .kpi-card .kpi-label { font-size: 0.82rem; color: var(--text-secondary); margin-bottom: 6px; }
        .kpi-card .kpi-value { font-size: 2rem; font-weight: 700; color: var(--header-dark); }
        .kpi-card .kpi-trend { font-size: 0.78rem; margin-top: 4px; }
        .kpi-card .kpi-trend.up { color: var(--success); }
        .kpi-card .kpi-trend.down { color: var(--danger); }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--header-dark), var(--accent)); }
        .kpi-card .kpi-progress { height: 6px; background: #e0e0e0; border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .kpi-card .kpi-progress-bar { height: 100%; border-radius: 3px; transition: width 0.6s ease; }

        /* ===== Trend Chart ===== */
        #trendChartSection { margin-bottom: 20px; }
        #trendChartSection canvas { max-height: 300px; }

        /* ===== Talent Pool ===== */
        .talent-pool-card {
            background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; border-radius: 12px;
            padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(239,68,68,0.3);
        }
        .talent-pool-card h3 { color: #fff; margin-bottom: 12px; font-size: 1.1rem; }
        .talent-member { display: inline-flex; align-items: center; background: rgba(255,255,255,0.2); border-radius: 8px; padding: 8px 14px; margin: 4px; font-size: 0.85rem; }
        .talent-member .talent-months { background: rgba(255,255,255,0.3); border-radius: 4px; padding: 2px 6px; margin-left: 8px; font-weight: 600; }

        /* ===== Quick Summary Overlay ===== */
        #quickSummaryOverlay {
            display: none; position: fixed; inset: 0; z-index: 1050;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
        }
        #quickSummaryOverlay .qs-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #fff; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        #quickSummaryOverlay .qs-panel h3 { margin: 0 0 16px; font-size: 1.2rem; color: var(--header-dark); }
        .qs-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .qs-item:last-child { border-bottom: none; }
        .qs-item .qs-label { color: var(--text-secondary); }
        .qs-item .qs-value { font-weight: 700; color: var(--header-dark); }

        /* ===== Dark Mode ===== */
        .dark-mode { --bg-light: #1a1a2e; --text-primary: #e0e0e0; --text-secondary: #a0a0a0; --card-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .dark-mode body, .dark-mode { background: #1a1a2e; color: #e0e0e0; }
        .dark-mode .kpi-card, .dark-mode .section-card, .dark-mode .validation-kpi-card { background: #16213e; border-color: #2a3a5c; }
        .dark-mode .kpi-card .kpi-value { color: #90caf9; }
        .dark-mode .dashboard-header { background: linear-gradient(135deg, #0d1b2a, #1b2838) !important; }
        .dark-mode table { color: #e0e0e0; }
        .dark-mode table thead { background: #1b2838; }
        .dark-mode table tbody tr:nth-child(even) { background: rgba(255,255,255,0.03); }
        .dark-mode table tbody tr:hover { background: rgba(255,255,255,0.08); }
        .dark-mode .filter-row input, .dark-mode .filter-row select { background: #16213e; color: #e0e0e0; border-color: #2a3a5c; }
        .dark-mode .modal-content { background: #16213e; color: #e0e0e0; }
        .dark-mode .modal-header { background: linear-gradient(135deg, #0d1b2a, #1b2838) !important; }
        .dark-mode #quickSummaryOverlay .qs-panel { background: #16213e; }
        .dark-mode .talent-pool-card { box-shadow: 0 4px 15px rgba(239,68,68,0.15); }
        .dark-mode .tabs .tab { color: #a0a0a0; }
        .dark-mode .tabs .tab.active { color: #90caf9; border-bottom-color: #90caf9; }
        .dark-mode .dashboard-footer { border-top-color: #2a3a5c; }

        /* ===== Validation KPI Grid ===== */
        .validation-kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 24px; }
        .validation-kpi-card {
            background: #fff; border-radius: 10px; padding: 16px;
            box-shadow: var(--card-shadow); cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;
            text-align: center; border: 1px solid #eee;
        }
        .validation-kpi-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .validation-kpi-card .vkpi-icon { font-size: 1.6rem; margin-bottom: 6px; }
        .validation-kpi-card .vkpi-title { font-size: 0.78rem; color: var(--text-secondary); margin-bottom: 4px; }
        .validation-kpi-card .vkpi-count { font-size: 1.6rem; font-weight: 700; }

        /* ===== Tables ===== */
        .table-container { background: #fff; border-radius: 10px; box-shadow: var(--card-shadow); overflow: hidden; margin-bottom: 20px; }
        .table-container table { width: 100%; border-collapse: collapse; }
        .table-container th {
            background: var(--header-dark); color: #fff; padding: 10px 14px;
            font-size: 0.82rem; font-weight: 600; text-align: left;
            position: sticky; top: 0; z-index: 2;
        }
        .table-container td { padding: 9px 14px; font-size: 0.84rem; border-bottom: 1px solid #f0f0f0; }
        .table-container tr:hover td { background: #f8f9ff; }
        .table-container tr:nth-child(even) td { background: #fafbfc; }
        .table-container tr:nth-child(even):hover td { background: #f0f3ff; }

        /* ===== Filter Row ===== */
        .filter-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px; align-items: center; }
        .filter-row input, .filter-row select {
            padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 0.85rem; background: #fff;
        }
        .filter-row input { min-width: 220px; }
        .filter-row select { min-width: 150px; }

        /* ===== Pagination ===== */
        .pagination-container { display: flex; justify-content: center; gap: 4px; margin-top: 14px; }
        .pagination-container button {
            padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px;
            background: #fff; cursor: pointer; font-size: 0.82rem;
        }
        .pagination-container button.active { background: var(--header-dark); color: #fff; border-color: var(--header-dark); }
        .pagination-container button:hover:not(.active) { background: #f0f4ff; }

        /* ===== Org Chart ===== */
        #orgChartContainer { min-height: 600px; background: #fff; border-radius: 10px; box-shadow: var(--card-shadow); padding: 16px; overflow: auto; }
        .org-action-btns { display: flex; gap: 8px; margin-top: 12px; }
        .org-action-btns button {
            padding: 6px 14px; border: 1px solid #ddd; border-radius: 6px;
            background: #fff; cursor: pointer; font-size: 0.82rem;
        }
        .org-action-btns button:hover { background: #f0f4ff; }
        #buildingSummaryCards { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 14px; }

        /* Org Chart Tree Nodes */
        #orgTreeContent ul { list-style: none; padding-left: 30px; position: relative; }
        #orgTreeContent > ul { padding-left: 0; }
        #orgTreeContent li { position: relative; padding: 6px 0; }
        #orgTreeContent li::before {
            content: ''; position: absolute; left: -20px; top: 0; bottom: 50%;
            border-left: 2px solid #d1d5db; border-bottom: 2px solid #d1d5db;
            width: 18px; height: calc(50% + 6px);
        }
        #orgTreeContent > ul > li::before { display: none; }
        #orgTreeContent li::after {
            content: ''; position: absolute; left: -20px; top: 50%; bottom: 0;
            border-left: 2px solid #d1d5db;
        }
        #orgTreeContent li:last-child::after { display: none; }

        .org-node {
            display: inline-block; padding: 12px 16px; background: #fff;
            border-radius: 10px; cursor: pointer; box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            position: relative; min-width: 190px; border-left: 4px solid #6b7280;
            transition: all 0.2s ease;
        }
        .org-node:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
        .org-node.manager { border-left-color: #6366f1; background: linear-gradient(135deg, #fff 0%, #eef2ff 100%); }
        .org-node.a-manager { border-left-color: #8b5cf6; background: linear-gradient(135deg, #fff 0%, #f3e8ff 100%); }
        .org-node.supervisor { border-left-color: #ec4899; background: linear-gradient(135deg, #fff 0%, #fce7f3 100%); }
        .org-node.group-leader { border-left-color: #f59e0b; background: linear-gradient(135deg, #fff 0%, #fef3c7 100%); }
        .org-node.line-leader { border-left-color: #10b981; background: linear-gradient(135deg, #fff 0%, #d1fae5 100%); }

        .org-node .node-incentive {
            position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; border-radius: 50%;
        }
        .org-node .node-incentive.received { background: #22c55e; box-shadow: 0 0 0 3px rgba(34,197,94,0.2); }
        .org-node .node-incentive.not-received { background: #ef4444; box-shadow: 0 0 0 3px rgba(239,68,68,0.2); }
        .org-node .node-position { font-size: 0.68rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px; }
        .org-node .node-name { font-size: 0.85rem; font-weight: 600; color: #1f2937; margin-bottom: 2px; }
        .org-node .node-id { font-size: 0.68rem; color: #9ca3af; }
        .org-node .node-incentive-info {
            margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(0,0,0,0.08);
            display: flex; justify-content: space-between; align-items: center;
        }
        .org-node .incentive-amount { font-size: 0.82rem; font-weight: 700; color: #059669; }
        .org-node .incentive-detail-btn {
            background: #6366f1; color: #fff; border: none; border-radius: 50%;
            width: 24px; height: 24px; display: inline-flex; align-items: center;
            justify-content: center; font-size: 12px; cursor: pointer; transition: transform 0.2s;
        }
        .org-node .incentive-detail-btn:hover { transform: scale(1.15); background: #4f46e5; }
        .org-node .subordinate-info { font-size: 0.7rem; color: #6b7280; margin-top: 4px; }
        .org-node .child-count {
            background: #ef4444; color: #fff; border-radius: 10px;
            padding: 1px 7px; font-size: 0.68rem; font-weight: 600; margin-left: 6px;
        }
        .org-node .toggle-btn {
            position: absolute; right: -28px; top: 50%; transform: translateY(-50%);
            width: 22px; height: 22px; background: #fff; border: 2px solid #d1d5db;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 14px; color: #6b7280; z-index: 5; transition: all 0.2s;
        }
        .org-node .toggle-btn:hover { border-color: #6366f1; color: #6366f1; }
        #orgTreeContent li.collapsed > ul { display: none; }
        #orgTreeContent li.collapsed .toggle-btn::after { content: '+'; }
        #orgTreeContent li.expanded .toggle-btn::after { content: 'âˆ’'; }

        .org-loading { text-align: center; padding: 40px; color: #6b7280; }
        .org-building-card {
            padding: 10px 16px; border-radius: 8px; background: #f9fafb;
            border: 1px solid #e5e7eb; min-width: 100px; text-align: center; cursor: default;
        }
        .org-building-card .bcard-label { font-size: 0.72rem; color: #6b7280; }
        .org-building-card .bcard-count { font-size: 1.1rem; font-weight: 700; color: #1f2937; }

        /* ===== Section Cards ===== */
        .section-card { background: #fff; border-radius: 10px; box-shadow: var(--card-shadow); padding: 20px; margin-bottom: 20px; }
        .section-card h3 { font-size: 1.05rem; margin: 0 0 14px; color: var(--header-dark); }

        /* ===== Badges ===== */
        .badge-pass { background: #e8f5e9; color: #2e7d32; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .badge-fail { background: #ffebee; color: #c62828; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .badge-na { background: #f5f5f5; color: #9e9e9e; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; }
        .badge-type { padding: 3px 8px; border-radius: 4px; font-size: 0.72rem; font-weight: 600; }
        .badge-type1 { background: #e3f2fd; color: #1565c0; }
        .badge-type2 { background: #fff3e0; color: #e65100; }
        .badge-type3 { background: #f3e5f5; color: #7b1fa2; }

        /* ===== Attendance Lookup ===== */
        .lookup-input-row { display: flex; gap: 10px; margin-bottom: 16px; max-width: 500px; }
        .lookup-input-row input { flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem; }
        .lookup-input-row button { padding: 10px 20px; background: var(--header-dark); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
        .lookup-input-row button:hover { background: var(--header-light); }

        /* ===== Attendance Calendar Grid ===== */
        .att-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 16px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .att-cal-header {
            text-align: center;
            font-size: 0.8rem;
            font-weight: 700;
            color: #1a237e;
            padding: 8px 0;
            border-bottom: 2px solid #e0e0e0;
        }
        .att-cal-header.weekend { color: #c62828; }
        .att-cal-cell {
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            padding: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .att-cal-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .att-cal-cell.work-day {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #fff;
        }
        .att-cal-cell.no-data {
            background: #f8f9fa;
            color: #495057;
            border: 2px dashed #dee2e6;
        }
        .att-cal-cell.weekend-day.no-data { background: #f0f0f0; }
        .att-cal-cell.empty { background: transparent; box-shadow: none; min-height: 0; }
        .att-cal-daynum { font-size: 1.4rem; font-weight: 700; line-height: 1; margin-bottom: 2px; }
        .att-cal-icon { font-size: 1.1rem; margin: 3px 0; }
        .att-cal-count {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            background: rgba(255,255,255,0.25);
            margin-top: 2px;
        }
        .att-cal-nodata { font-size: 0.9rem; color: #aaa; margin-top: 4px; }
        .att-cal-nodata i { color: #bbb; }

        /* Mini calendar for modals */
        .att-mini-calendar { gap: 4px; padding: 10px; margin-top: 12px; }
        .att-mini-calendar .att-cal-header { font-size: 0.7rem; padding: 4px 0; }
        .att-mini-calendar .att-cal-cell { min-height: 52px; padding: 4px; }
        .att-mini-calendar .att-cal-daynum { font-size: 0.95rem; }
        .att-mini-calendar .att-cal-icon { font-size: 0.8rem; margin: 1px 0; }
        .att-mini-calendar .att-cal-count { font-size: 0.65rem; padding: 1px 5px; }

        @media (max-width: 576px) {
            .att-calendar-grid { gap: 4px; padding: 8px; }
            .att-cal-cell { min-height: 60px; padding: 4px; }
            .att-cal-daynum { font-size: 1rem; }
            .att-cal-count { font-size: 0.65rem; }
        }

        /* ===== Footer ===== */
        .dashboard-footer { text-align: center; padding: 16px; font-size: 0.75rem; color: var(--text-secondary); border-top: 1px solid #eee; margin-top: 20px; }

        /* ===== Responsive ===== */
        @media (max-width: 992px) {
            .kpi-row { grid-template-columns: repeat(2, 1fr); }
            .validation-kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .dashboard-header { padding: 12px 16px; }
            .tab-content { padding: 14px; }
        }
        @media (max-width: 576px) {
            .validation-kpi-grid { grid-template-columns: 1fr; }
            .dashboard-header h1 { font-size: 1.1rem; }
            .filter-row { flex-direction: column; }
            .filter-row input, .filter-row select { min-width: 100%; }
        }

        /* ===== Print ===== */
        @media print {
            .dashboard-header, .tabs, .filter-row, .org-action-btns, .pagination-container, .dashboard-footer, .btn-logout, .header-controls { display: none !important; }
            .tab-content { display: block !important; padding: 0; }
            .kpi-card, .validation-kpi-card, .section-card, .table-container { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
            body { background: #fff; }
        }
    </style>
</head>
<body>

<!-- ============================================================ -->
<!-- LOADING OVERLAY                                              -->
<!-- ============================================================ -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <p data-i18n="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<!-- ============================================================ -->
<!-- ERROR MESSAGE                                                -->
<!-- ============================================================ -->
<div id="error-message">
    <h4><i class="fas fa-exclamation-triangle"></i> <span data-i18n="errorTitle">ì˜¤ë¥˜ ë°œìƒ</span></h4>
    <p id="error-text"></p>
</div>

<!-- ============================================================ -->
<!-- HEADER                                                       -->
<!-- ============================================================ -->
<header class="dashboard-header">
    <div class="title-section">
        <h1>HWK QIP Incentive Dashboard</h1>
        <div class="meta">
            <span id="dashboard-month-year">--</span>
            <span style="margin: 0 6px;">|</span>
            <span data-i18n="lastUpdated">ìµœì¢… ì—…ë°ì´íŠ¸:</span>
            <span id="last-updated">--</span>
        </div>
    </div>
    <div class="header-controls">
        <button class="lang-btn active" data-lang="ko" onclick="switchLanguage('ko')">KO</button>
        <button class="lang-btn" data-lang="en" onclick="switchLanguage('en')">EN</button>
        <button class="lang-btn" data-lang="vi" onclick="switchLanguage('vi')">VN</button>
        <button class="header-link" onclick="toggleDarkMode()" title="Dark Mode" id="darkModeToggle" style="cursor:pointer; background:none; border:1px solid rgba(255,255,255,0.3); border-radius:6px; color:#fff; padding:4px 10px; font-size:0.9rem;">ğŸŒ™</button>
        <button class="header-link" onclick="toggleQuickSummary()" title="Quick Summary" style="cursor:pointer; background:none; border:1px solid rgba(255,255,255,0.3); border-radius:6px; color:#fff; padding:4px 10px; font-size:0.9rem;">ğŸ“‹</button>
        <button class="header-link" onclick="showMyIncentive()" title="My Incentive" style="cursor:pointer; background:none; border:1px solid rgba(255,255,255,0.3); border-radius:6px; color:#fff; padding:4px 10px; font-size:0.85rem;"><i class="fas fa-search"></i> <span data-i18n="myIncentive.btnLabel">ë‚´ ì¸ì„¼í‹°ë¸Œ</span></button>
        <button class="header-link" onclick="downloadExcel()" title="Excel Download" style="cursor:pointer; background:none; border:1px solid rgba(255,255,255,0.3); border-radius:6px; color:#fff; padding:4px 10px; font-size:0.85rem;"><i class="fas fa-file-excel"></i> Excel</button>
        <button class="header-link" id="dataPeriodToggle" onclick="toggleDataPeriod()" title="Data Period" style="cursor:pointer; background:none; border:1px solid rgba(255,255,255,0.3); border-radius:6px; color:#fff; padding:4px 10px; font-size:0.85rem;">ğŸ“… <span data-i18n="dataPeriod.final">ìµœì¢… ë³´ê³ ì„œ</span></button>
        <a href="selector.html" class="header-link" data-i18n="common.back"><i class="fas fa-arrow-left"></i> ì›” ì„ íƒ</a>
        <span class="user-email" id="userEmail"></span>
        <button class="btn-logout" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> <span data-i18n="common.logout">ë¡œê·¸ì•„ì›ƒ</span></button>
    </div>
</header>

<!-- ============================================================ -->
<!-- TAB NAVIGATION                                               -->
<!-- ============================================================ -->
<div class="tabs" id="mainTabs">
    <div class="tab active" data-tab="summary" onclick="showTab('summary')"><span data-i18n="tabs.summary">ìš”ì•½</span></div>
    <div class="tab" data-tab="position" onclick="showTab('position')"><span data-i18n="tabs.position">ì§ê¸‰ë³„ ìƒì„¸</span></div>
    <div class="tab" data-tab="detail" onclick="showTab('detail')"><span data-i18n="tabs.individual">ê°œì¸ë³„ ìƒì„¸</span></div>
    <div class="tab" data-tab="criteria" onclick="showTab('criteria')"><span data-i18n="tabs.criteria">ì¸ì„¼í‹°ë¸Œ ê¸°ì¤€</span></div>
    <div class="tab" data-tab="orgchart" onclick="showTab('orgchart')"><span data-i18n="tabs.orgchart">ì¡°ì§ë„</span></div>
    <div class="tab" data-tab="team" onclick="showTab('team')"><span data-i18n="nav.team">íŒ€ ê´€ë¦¬</span></div>
    <div class="tab" data-tab="validation" onclick="showTab('validation')"><span data-i18n="tabs.validation">ìš”ì•½ ë° ì‹œìŠ¤í…œ ê²€ì¦</span></div>
    <div class="tab" data-tab="attendance-lookup" onclick="showTab('attendance-lookup')"><i class="fas fa-search"></i> <span data-i18n="tabs.attendanceLookup">ê°œì¸ ì¶œê²° ì¡°íšŒ</span></div>
</div>

<!-- ============================================================ -->
<!-- TAB: SUMMARY                                                 -->
<!-- ============================================================ -->
<div class="tab-content active-tab" id="summary" style="display: block;">
    <!-- KPI Cards (4 cards) -->
    <div class="kpi-row">
        <div class="kpi-card">
            <div class="kpi-icon">ğŸ‘¤</div>
            <div class="kpi-label" data-i18n="kpi.totalEmployees">ì „ì²´ ì§ì›</div>
            <div class="kpi-value" id="totalEmployeesValue">--</div>
            <div class="kpi-trend" id="totalEmployeesTrend"></div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">ğŸ‘¥</div>
            <div class="kpi-label" data-i18n="kpi.recipients">ìˆ˜ë ¹ ì§ì›</div>
            <div class="kpi-value" id="recipientsCountValue">--</div>
            <div class="kpi-trend" id="recipientsTrend"></div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">ğŸ“Š</div>
            <div class="kpi-label" data-i18n="kpi.paymentRate">ì§€ê¸‰ë¥ </div>
            <div class="kpi-value" id="paymentRateValue">--</div>
            <div class="kpi-progress"><div class="kpi-progress-bar" id="paymentRateBar" style="width:0%; background: var(--success);"></div></div>
            <div class="kpi-trend" id="paymentRateTrend"></div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">ğŸ’°</div>
            <div class="kpi-label" data-i18n="kpi.totalAmount">ì´ ì§€ê¸‰ì•¡</div>
            <div class="kpi-value" id="totalAmountValue">--</div>
            <div class="kpi-trend" id="totalAmountTrend"></div>
        </div>
    </div>

    <!-- Trend Chart (Previous vs Current) -->
    <div class="section-card" id="trendChartSection" style="display:none;">
        <h3 data-i18n="chart.trendTitle">ì „ì›” ëŒ€ë¹„ ì¸ì„¼í‹°ë¸Œ ë¶„ì„</h3>
        <canvas id="trendChart"></canvas>
    </div>

    <!-- TYPE Table -->
    <div class="section-card">
        <h3 data-i18n="summary.typeOverview">TYPEë³„ í˜„í™©</h3>
        <div id="typeTableContainer"></div>
    </div>

    <!-- Talent Pool Section -->
    <div id="talentPoolSection" style="display:none;"></div>

    <!-- Condition Summary Charts -->
    <div class="section-card">
        <h3 data-i18n="summary.conditionCharts">ì¡°ê±´ë³„ ì¶©ì¡± í˜„í™©</h3>
        <div id="conditionChartsContainer"></div>
    </div>
</div>

<!-- ============================================================ -->
<!-- TAB: POSITION DETAIL                                         -->
<!-- ============================================================ -->
<div class="tab-content" id="position">
    <div id="positionTables">
        <p class="text-muted" data-i18n="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</div>

<!-- ============================================================ -->
<!-- TAB: INDIVIDUAL DETAIL                                       -->
<!-- ============================================================ -->
<div class="tab-content" id="detail">
    <!-- Filters -->
    <div class="filter-row">
        <input type="text" id="employeeSearch" placeholder="ì‚¬ë²ˆ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰" data-i18n="filter.search">
        <select id="positionFilter">
            <option value="" data-i18n="filter.allPositions">ì „ì²´ ì§ê¸‰</option>
        </select>
        <select id="buildingFilter">
            <option value="" data-i18n="filter.allBuildings">ì „ì²´ Building</option>
        </select>
        <select id="incentiveFilter">
            <option value="" data-i18n="filter.all">ì „ì²´</option>
            <option value="received" data-i18n="filter.received">ìˆ˜ë ¹</option>
            <option value="not-received" data-i18n="filter.notReceived">ë¯¸ìˆ˜ë ¹</option>
        </select>
    </div>

    <!-- Employee Table -->
    <div class="table-container" style="max-height: 600px; overflow-y: auto;">
        <table>
            <thead>
                <tr>
                    <th data-i18n="table.no">ë²ˆí˜¸</th>
                    <th data-i18n="table.empNo">ì‚¬ë²ˆ</th>
                    <th data-i18n="table.name">ì´ë¦„</th>
                    <th data-i18n="table.position">ì§ê¸‰</th>
                    <th data-i18n="table.building">Building</th>
                    <th data-i18n="table.type">TYPE</th>
                    <th data-i18n="table.attendance">ì¶œê·¼ìœ¨</th>
                    <th data-i18n="table.aql">AQL</th>
                    <th data-i18n="table.5prs">5PRS</th>
                    <th data-i18n="table.incentive">ì¸ì„¼í‹°ë¸Œ</th>
                    <th data-i18n="table.detail">ìƒì„¸</th>
                </tr>
            </thead>
            <tbody id="employeeTableBody"></tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" id="tablePagination"></div>
</div>

<!-- ============================================================ -->
<!-- TAB: CRITERIA                                                -->
<!-- ============================================================ -->
<div class="tab-content" id="criteria">
    <!-- 10 Conditions Overview -->
    <div class="section-card">
        <h3 data-i18n="criteria.conditionsTitle">10ê°€ì§€ ì¡°ê±´ ê°œìš”</h3>
        <div id="conditionsOverview">
            <p class="text-muted" data-i18n="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <!-- TYPE Calculation Methods -->
    <div class="section-card">
        <h3 data-i18n="criteria.typeCalcTitle">TYPEë³„ ì¸ì„¼í‹°ë¸Œ ê³„ì‚° ë°©ë²•</h3>
        <div id="typeCalculationMethods">
            <p class="text-muted" data-i18n="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <!-- FAQ -->
    <div class="section-card">
        <h3 data-i18n="criteria.faqTitle">ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (FAQ)</h3>
        <div id="faqSection">
            <p class="text-muted" data-i18n="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>
</div>

<!-- ============================================================ -->
<!-- TAB: ORG CHART                                               -->
<!-- ============================================================ -->
<div class="tab-content" id="orgchart">
    <h3 id="orgChartTitle" data-i18n="orgchart.title">ì¡°ì§ë„ - ì¸ì„¼í‹°ë¸Œ êµ¬ì¡°</h3>

    <!-- Org Filters -->
    <div class="filter-row">
        <select id="orgIncentiveFilter">
            <option value="" data-i18n="filter.all">ì „ì²´</option>
            <option value="paid" data-i18n="filter.received">ìˆ˜ë ¹</option>
            <option value="unpaid" data-i18n="filter.notReceived">ë¯¸ìˆ˜ë ¹</option>
        </select>
        <select id="orgBuildingFilter">
            <option value="" data-i18n="filter.allBuildings">ì „ì²´ Building</option>
        </select>
    </div>

    <!-- Building Summary Cards -->
    <div id="buildingSummaryCards"></div>

    <!-- Org Chart Tree Container -->
    <div id="orgChartContainer">
        <div id="orgTreeContent">
            <p class="text-muted" data-i18n="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="org-action-btns">
        <button onclick="expandAllNodes()"><i class="fas fa-expand-arrows-alt"></i> <span data-i18n="orgchart.expandAll">ì „ì²´ í¼ì¹˜ê¸°</span></button>
        <button onclick="collapseAllNodes()"><i class="fas fa-compress-arrows-alt"></i> <span data-i18n="orgchart.collapseAll">ì „ì²´ ì ‘ê¸°</span></button>
        <button onclick="findMyNode()"><i class="fas fa-crosshairs"></i> <span data-i18n="orgchart.findMe">ë‚´ ìœ„ì¹˜ ì°¾ê¸°</span></button>
    </div>
</div>

<!-- ============================================================ -->
<!-- TAB: TEAM                                                    -->
<!-- ============================================================ -->
<div class="tab-content" id="team">
    <div id="teamSummaryCards" style="display: flex; flex-wrap: wrap; gap: 14px; margin-bottom: 20px;"></div>
    <div id="teamTableContainer">
        <p class="text-muted" data-i18n="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</div>

<!-- ============================================================ -->
<!-- TAB: VALIDATION                                              -->
<!-- ============================================================ -->
<div class="tab-content" id="validation">
    <!-- 12 KPI Cards -->
    <div class="validation-kpi-grid">
        <div class="validation-kpi-card" onclick="showValidationDetail('totalWorkingDays')">
            <div class="vkpi-icon"><i class="fas fa-calendar-check" style="color: #1976d2;"></i></div>
            <div class="vkpi-title" data-i18n="validation.totalWorkingDays">ì´ ê·¼ë¬´ì¼</div>
            <div class="vkpi-count" id="kpiTotalWorkingDays">--</div>
        </div>
        <div class="validation-kpi-card" onclick="showValidationDetail('absentWithoutInform')">
            <div class="vkpi-icon"><i class="fas fa-user-slash" style="color: #e65100;"></i></div>
            <div class="vkpi-title" data-i18n="validation.absentWithoutInform">ë¬´ë‹¨ê²°ê·¼</div>
            <div class="vkpi-count" id="kpiAbsentWithoutInform">--</div>
        </div>
        <div class="validation-kpi-card" onclick="showValidationDetail('zeroWorkingDays')">
            <div class="vkpi-icon"><i class="fas fa-ban" style="color: #c62828;"></i></div>
            <div class="vkpi-title" data-i18n="validation.zeroWorkingDays">ê·¼ë¬´ì¼ 0ì¼</div>
            <div class="vkpi-count" id="kpiZeroWorkingDays">--</div>
        </div>
        <div class="validation-kpi-card" onclick="showValidationDetail('minimumDaysNotMet')">
            <div class="vkpi-icon"><i class="fas fa-calendar-minus" style="color: #f57c00;"></i></div>
            <div class="vkpi-title" data-i18n="validation.minimumDaysNotMet">ìµœì†Œ ê·¼ë¬´ì¼ ë¯¸ë‹¬</div>
            <div class="vkpi-count" id="kpiMinimumDaysNotMet">--</div>
        </div>
        <div class="validation-kpi-card" onclick="showValidationDetail('attendanceBelow88')">
            <div class="vkpi-icon"><i class="fas fa-percentage" style="color: #d32f2f;"></i></div>
            <div class="vkpi-title" data-i18n="validation.attendanceBelow">ì¶œê·¼ìœ¨ ë¯¸ë‹¬</div>
            <div class="vkpi-count" id="kpiAttendanceBelow88">--</div>
        </div>
        <div class="validation-kpi-card" onclick="showValidationDetail('aqlFail')">
            <div class="vkpi-icon"><i class="fas fa-search-minus" style="color: #b71c1c;"></i></div>
            <div class="vkpi-title" data-i18n="validation.aqlFail">AQL ë¶ˆí•©ê²©</div>
            <div class="vkpi-count" id="kpiAqlFail">--</div>
        </div>
        <div class="validation-kpi-card" onclick="showValidationDetail('consecutiveAqlFail')">
            <div class="vkpi-icon"><i class="fas fa-exclamation-triangle" style="color: #ff6f00;"></i></div>
            <div class="vkpi-title" data-i18n="validation.consecutiveAqlFail">ì—°ì† AQL ì‹¤íŒ¨</div>
            <div class="vkpi-count" id="kpiConsecutiveAqlFail">--</div>
        </div>
        <div class="validation-kpi-card" onclick="showValidationDetail('areaRejectRate')">
            <div class="vkpi-icon"><i class="fas fa-chart-bar" style="color: #e64a19;"></i></div>
            <div class="vkpi-title" data-i18n="validation.areaRejectRate">Area Reject Rate ì´ˆê³¼</div>
            <div class="vkpi-count" id="kpiAreaRejectRate">--</div>
        </div>
        <div class="validation-kpi-card" onclick="showValidationDetail('lowPassRate')">
            <div class="vkpi-icon"><i class="fas fa-clipboard-check" style="color: #6a1b9a;"></i></div>
            <div class="vkpi-title" data-i18n="validation.lowPassRate">5PRS í†µê³¼ìœ¨ ë¯¸ë‹¬</div>
            <div class="vkpi-count" id="kpiLowPassRate">--</div>
        </div>
        <div class="validation-kpi-card" onclick="showValidationDetail('lowInspectionQty')">
            <div class="vkpi-icon"><i class="fas fa-boxes" style="color: #4527a0;"></i></div>
            <div class="vkpi-title" data-i18n="validation.lowInspectionQty">5PRS ê²€ì‚¬ëŸ‰ ë¯¸ë‹¬</div>
            <div class="vkpi-count" id="kpiLowInspectionQty">--</div>
        </div>
        <div class="validation-kpi-card" onclick="showValidationDetail('buildingReviewTotal')">
            <div class="vkpi-icon"><i class="fas fa-building" style="color: #ff9800;"></i></div>
            <div class="vkpi-title" data-i18n="validation.crossBuilding">êµì°¨ Building ê²€í† </div>
            <div class="vkpi-count" id="kpiBuildingReviewTotal">--</div>
        </div>
        <div class="validation-kpi-card" onclick="showValidationDetail('lineLeaderNotAssigned')">
            <div class="vkpi-icon"><i class="fas fa-user-tie" style="color: #455a64;"></i></div>
            <div class="vkpi-title" data-i18n="validation.lineLeaderNotAssigned">LINE LEADER ë¯¸ë°°ì •</div>
            <div class="vkpi-count" id="kpiLineLeaderNotAssigned">--</div>
        </div>
    </div>

    <!-- Attendance Calendar -->
    <div class="section-card">
        <h3 data-i18n="validation.attendanceCalendar">ì¶œê·¼ ìº˜ë¦°ë”</h3>
        <div id="attendanceCalendarSection"></div>
    </div>
</div>

<!-- ============================================================ -->
<!-- TAB: ATTENDANCE LOOKUP                                       -->
<!-- ============================================================ -->
<div class="tab-content" id="attendance-lookup">
    <div class="section-card">
        <h3 data-i18n="attendanceLookup.title">ê°œì¸ ì¶œê²° ì¡°íšŒ</h3>
        <div class="lookup-input-row">
            <input type="text" id="attendanceLookupInput" placeholder="ì‚¬ë²ˆ ì…ë ¥" data-i18n-placeholder="attendanceLookup.placeholder">
            <button onclick="searchAttendance()"><i class="fas fa-search"></i> <span data-i18n="attendanceLookup.search">ì¡°íšŒ</span></button>
        </div>
        <div id="attendanceLookupResult"></div>
    </div>
</div>

<!-- ============================================================ -->
<!-- MODALS                                                       -->
<!-- ============================================================ -->

<!-- Employee Detail Modal -->
<div class="modal fade" id="employeeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--header-dark), var(--header-light)); color: #fff;">
                <h5 class="modal-title" id="employeeModalTitle" data-i18n="modal.employeeDetail">ì§ì› ìƒì„¸ ì •ë³´</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="employeeModalBody"></div>
        </div>
    </div>
</div>

<!-- Position Detail Modal -->
<div class="modal fade" id="positionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--header-dark), var(--header-light)); color: #fff;">
                <h5 class="modal-title" id="positionModalTitle" data-i18n="modal.positionDetail">ì§ê¸‰ë³„ ìƒì„¸ ì •ë³´</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="positionModalBody"></div>
        </div>
    </div>
</div>

<!-- ============================================================ -->
<!-- QUICK SUMMARY OVERLAY                                        -->
<!-- ============================================================ -->
<div id="quickSummaryOverlay" onclick="toggleQuickSummary()">
    <div class="qs-panel" onclick="event.stopPropagation()">
        <h3>ğŸ“‹ <span data-i18n="quickSummary.title">ë¹ ë¥¸ ìš”ì•½</span></h3>
        <div id="quickSummaryContent"></div>
        <div style="text-align:center; margin-top: 16px;">
            <button onclick="toggleQuickSummary()" style="padding: 8px 24px; border-radius: 8px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;">
                <span data-i18n="quickSummary.close">ë‹«ê¸°</span>
            </button>
        </div>
    </div>
</div>

<!-- ============================================================ -->
<!-- FOOTER                                                       -->
<!-- ============================================================ -->
<footer class="dashboard-footer">
    <span>HWK QIP Incentive Dashboard v10.0</span>
    <span style="margin: 0 8px;">|</span>
    <span data-i18n="footer.dataSource">Data source: Firestore</span>
    <span style="margin: 0 8px;">|</span>
    <span id="footerTimestamp"></span>
</footer>

<!-- ============================================================ -->
<!-- CDN: JS Dependencies (before closing body)                   -->
<!-- ============================================================ -->
<!-- CDN: Bootstrap 5.3.2 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- CDN: Chart.js 4.4.0 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- CDN: D3.js v7 -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- CDN: Firebase v10.7.1 compat -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- ============================================================ -->
<!-- Local JS Modules (load order matters)                        -->
<!-- ============================================================ -->
<script src="js/firebase-config.js?v=20260227fix1"></script>
<script src="js/auth.js?v=20260227fix1"></script>
<script src="js/dashboard-data.js?v=20260227fix1"></script>
<script src="js/dashboard-i18n.js?v=20260227fix3"></script>
<script src="js/dashboard-charts.js?v=20260227fix1"></script>
<script src="js/dashboard-filters.js?v=20260227fix1"></script>
<script src="js/dashboard-modals.js?v=20260227fix4"></script>

<!-- ============================================================ -->
<!-- Initialization                                               -->
<!-- ============================================================ -->
<script>
    /**
     * Show a specific tab and hide all others.
     * @param {string} tabName - The data-tab value of the tab to show.
     */
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(function(c) {
            c.style.display = 'none';
        });
        document.querySelectorAll('.tab').forEach(function(t) {
            t.classList.remove('active');
        });
        var content = document.getElementById(tabName);
        if (content) content.style.display = 'block';
        var tab = document.querySelector('.tab[data-tab="' + tabName + '"]');
        if (tab) tab.classList.add('active');
    }

    /**
     * Switch UI language.
     * @param {string} lang - Language code: 'ko', 'en', or 'vn'.
     */
    function switchLanguage(lang) {
        if (typeof DashboardI18n !== 'undefined' && DashboardI18n.switchLanguage) {
            DashboardI18n.switchLanguage(lang);
        }
    }

    /**
     * Handle user logout.
     */
    function handleLogout() {
        if (typeof logout === 'function') {
            logout();
        } else if (typeof firebase !== 'undefined') {
            firebase.auth().signOut().then(function() {
                window.location.href = 'auth.html';
            });
        }
    }

    /**
     * Hide loading overlay and show content.
     */
    function hideLoading() {
        var overlay = document.getElementById('loading-overlay');
        if (overlay) overlay.style.display = 'none';
    }

    /**
     * Show error message to user.
     * @param {string} message - The error text to display.
     */
    function showError(message) {
        hideLoading();
        var errorDiv = document.getElementById('error-message');
        var errorText = document.getElementById('error-text');
        if (errorDiv && errorText) {
            errorText.textContent = message;
            errorDiv.style.display = 'block';
        }
    }

    /* Placeholder functions for org chart actions (implemented by dashboard-charts.js) */
    function expandAllNodes() {
        if (typeof DashboardCharts !== 'undefined' && DashboardCharts.expandAll) DashboardCharts.expandAll();
    }
    function collapseAllNodes() {
        if (typeof DashboardCharts !== 'undefined' && DashboardCharts.collapseAll) DashboardCharts.collapseAll();
    }
    function findMyNode() {
        if (typeof DashboardCharts !== 'undefined' && DashboardCharts.findMe) DashboardCharts.findMe();
    }

    /* Placeholder for validation detail click handler (implemented by dashboard-modals.js) */
    function showValidationDetail(type) {
        if (typeof DashboardModals !== 'undefined' && DashboardModals.showValidation) {
            DashboardModals.showValidation(type);
        }
    }

    /* Placeholder for attendance lookup (implemented by dashboard-data.js or dashboard-filters.js) */
    function searchAttendance() {
        var input = document.getElementById('attendanceLookupInput');
        if (!input) return;
        var empId = input.value.trim();
        if (!empId) return;
        if (typeof DashboardFilters !== 'undefined' && DashboardFilters.searchAttendance) {
            DashboardFilters.searchAttendance(empId);
        }
    }

    /**
     * Download Excel file from GitHub Pages.
     * Uses window._dashboardMonth / _dashboardYear set by dashboard-data.js.
     */
    function downloadExcel() {
        var month = (window._dashboardMonth || 'february').toLowerCase();
        var year = window._dashboardYear || 2026;
        var filename = 'output_QIP_incentive_' + month + '_' + year + '_Complete_V10.0_Complete.xlsx';
        var url = filename;
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    /**
     * Toggle Quick Summary overlay.
     * Renders core KPI stats + TYPE breakdown in a centered panel.
     */
    function toggleQuickSummary() {
        var overlay = document.getElementById('quickSummaryOverlay');
        if (!overlay) return;

        if (overlay.style.display === 'flex') {
            overlay.style.display = 'none';
            return;
        }

        // Populate content
        var content = document.getElementById('quickSummaryContent');
        if (content && window.employeeData) {
            var employees = window.employeeData;
            var total = employees.length;
            var receiving = 0, totalAmt = 0;
            var typeStats = { 'TYPE-1': { count: 0, recv: 0 }, 'TYPE-2': { count: 0, recv: 0 }, 'TYPE-3': { count: 0, recv: 0 } };

            employees.forEach(function(emp) {
                var amt = window.employeeHelpers ? window.employeeHelpers.getIncentive(emp, 'current') : (emp.currentIncentive || 0);
                var empType = String(emp.type || emp.TYPE || emp['ROLE TYPE STD'] || 'TYPE-3').toUpperCase();
                if (!empType.startsWith('TYPE')) empType = 'TYPE-' + empType;
                if (!typeStats[empType]) empType = 'TYPE-3';

                typeStats[empType].count++;
                if (amt > 0) { receiving++; totalAmt += amt; typeStats[empType].recv++; }
            });

            var t = (typeof DashboardI18n !== 'undefined') ? DashboardI18n.t.bind(DashboardI18n) : function(k) { return k; };
            var rate = total > 0 ? ((receiving / total) * 100).toFixed(1) : '0.0';

            var html = '';
            html += '<div class="qs-item"><span class="qs-label">' + t('quickSummary.recipients') + '</span><span class="qs-value">' + receiving.toLocaleString() + ' / ' + total.toLocaleString() + '</span></div>';
            html += '<div class="qs-item"><span class="qs-label">' + t('quickSummary.paymentRate') + '</span><span class="qs-value">' + rate + '%</span></div>';
            html += '<div class="qs-item"><span class="qs-label">' + t('quickSummary.totalAmount') + '</span><span class="qs-value">' + totalAmt.toLocaleString() + ' VND</span></div>';
            html += '<hr style="margin: 12px 0; border-color: #eee;">';
            ['TYPE-1', 'TYPE-2', 'TYPE-3'].forEach(function(tp) {
                var s = typeStats[tp];
                html += '<div class="qs-item"><span class="qs-label">' + tp + '</span><span class="qs-value">' + s.recv + ' / ' + s.count + '</span></div>';
            });
            content.innerHTML = html;
        }

        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
    }

    /**
     * Show My Incentive lookup: prompt for emp number, open employee modal.
     * Reuses DashboardModals.showEmployeeDetail() (Issue #62 safe).
     */
    function showMyIncentive() {
        var t = (typeof DashboardI18n !== 'undefined') ? DashboardI18n.t.bind(DashboardI18n) : function(k) { return k; };
        var empNo = prompt(t('myIncentive.placeholder'));
        if (!empNo || !empNo.trim()) return;

        empNo = empNo.trim();

        // Try to find employee
        if (window.employeeData) {
            var found = window.employeeData.find(function(emp) {
                return String(emp.emp_no || emp['Employee No'] || '') === String(empNo);
            });

            if (!found) {
                alert(t('myIncentive.notFound'));
                return;
            }
        }

        if (typeof DashboardModals !== 'undefined' && DashboardModals.showEmployeeDetail) {
            DashboardModals.showEmployeeDetail(empNo);
        }
    }

    /**
     * Toggle Dark Mode. Persists preference in localStorage.
     */
    function toggleDarkMode() {
        var isDark = document.documentElement.classList.toggle('dark-mode');
        localStorage.setItem('qip_dark_mode', isDark ? 'true' : 'false');

        // Update toggle button
        var btn = document.getElementById('darkModeToggle');
        if (btn) btn.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';

        // Update Chart.js charts for dark mode
        if (typeof DashboardCharts !== 'undefined') {
            var textColor = isDark ? '#e0e0e0' : '#212121';
            var gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            Object.values(DashboardCharts.charts).forEach(function(chart) {
                if (chart && chart.options && chart.options.scales) {
                    ['x', 'y'].forEach(function(axis) {
                        if (chart.options.scales[axis]) {
                            if (chart.options.scales[axis].ticks) chart.options.scales[axis].ticks.color = textColor;
                            if (chart.options.scales[axis].grid) chart.options.scales[axis].grid.color = gridColor;
                        }
                    });
                    if (chart.options.plugins && chart.options.plugins.legend && chart.options.plugins.legend.labels) {
                        chart.options.plugins.legend.labels.color = textColor;
                    }
                    chart.update();
                }
            });
        }
    }

    /**
     * Toggle Data Period (Interim/Final report mode).
     * Affects condition display in validation tab.
     */
    function toggleDataPeriod() {
        window._isInterimReport = !window._isInterimReport;
        var t = (typeof DashboardI18n !== 'undefined') ? DashboardI18n.t.bind(DashboardI18n) : function(k) { return k; };

        // Update display
        var btn = document.getElementById('dataPeriodToggle');
        if (btn) {
            btn.textContent = window._isInterimReport ? t('dataPeriod.interim') : t('dataPeriod.final');
        }

        // Re-render validation KPIs if available
        if (typeof DashboardCharts !== 'undefined' && DashboardCharts._criteriaData) {
            DashboardCharts.renderValidationKPIs(DashboardCharts._criteriaData);
        }
    }

    /**
     * Main initialization â€” runs after DOM is ready.
     */
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            // 1. Check authentication
            var user = null;
            if (typeof checkAuth === 'function') {
                user = await checkAuth();
            }
            if (!user) {
                hideLoading();
                return;
            }

            // Display user email
            var emailEl = document.getElementById('userEmail');
            if (emailEl && user.email) emailEl.textContent = user.email;

            // 2. Get month/year from URL params
            var params = new URLSearchParams(window.location.search);
            var month = params.get('month') || 'february';
            var year = parseInt(params.get('year')) || 2026;

            // 3. Update page title with month/year
            var monthYearEl = document.getElementById('dashboard-month-year');
            if (monthYearEl) {
                monthYearEl.textContent = month.charAt(0).toUpperCase() + month.slice(1) + ' ' + year;
            }

            // 4. Load all data from Firestore
            var data = null;
            if (typeof DashboardData !== 'undefined' && DashboardData.loadAll) {
                data = await DashboardData.loadAll(month, year);
            }

            if (!data) {
                showError('Failed to load dashboard data. Please try again.');
                return;
            }

            // 5. Initialize all dashboard components
            // [CRITICAL] DashboardI18n MUST init BEFORE DashboardCharts
            // so that t() can resolve criteria.*/faq.* keys during renderCriteriaTab()
            if (typeof DashboardI18n !== 'undefined' && DashboardI18n.init) DashboardI18n.init();
            if (typeof DashboardCharts !== 'undefined' && DashboardCharts.init) DashboardCharts.init(data);
            if (typeof DashboardFilters !== 'undefined' && DashboardFilters.init) DashboardFilters.init(data);
            if (typeof DashboardModals !== 'undefined' && DashboardModals.init) DashboardModals.init(data);

            // 6. Update last-updated and footer timestamp
            var lastUpdatedEl = document.getElementById('last-updated');
            if (lastUpdatedEl && data.metadata && data.metadata.lastUpdated) {
                try {
                    var updatedDate = new Date(data.metadata.lastUpdated);
                    lastUpdatedEl.textContent = updatedDate.toLocaleString();
                } catch (e) {
                    lastUpdatedEl.textContent = data.metadata.lastUpdated;
                }
            }
            var footerTs = document.getElementById('footerTimestamp');
            if (footerTs) {
                footerTs.textContent = new Date().toLocaleString();
            }

            // 7. Restore Dark Mode preference from localStorage
            if (localStorage.getItem('qip_dark_mode') === 'true') {
                document.documentElement.classList.add('dark-mode');
                var dmBtn = document.getElementById('darkModeToggle');
                if (dmBtn) dmBtn.textContent = 'â˜€ï¸';
            }

            // 8. Show default tab and hide loading
            showTab('summary');
            hideLoading();

        } catch (err) {
            console.error('Dashboard initialization failed:', err);
            showError('Dashboard initialization failed: ' + (err.message || err));
        }
    });
</script>

</body>
</html>
