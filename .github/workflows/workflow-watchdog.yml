name: ğŸ›¡ï¸ Workflow Watchdog (ë¹„í™œì„±í™” ê°ì§€ ë° ìë™ ë³µêµ¬)

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (ë² íŠ¸ë‚¨ ì‹œê°„ = UTC+7, ê·¸ë˜ì„œ UTC 02:00)
    - cron: '0 2 * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

permissions:
  contents: write
  actions: write

env:
  ALERT_EMAIL: ksmoon@hsvina.com
  MAIN_WORKFLOW_FILE: auto-update.yml

jobs:
  watchdog:
    runs-on: ubuntu-latest

    steps:
    # 0. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ (Keep-Alive ì»¤ë°‹ì— í•„ìš”)
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        persist-credentials: true
        fetch-depth: 1

    - name: ğŸ” Check Main Workflow Status
      id: check_status
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "=== ë©”ì¸ ì›Œí¬í”Œë¡œìš° ìƒíƒœ í™•ì¸ ==="

        # ì›Œí¬í”Œë¡œìš° ìƒíƒœ ì¡°íšŒ
        WORKFLOW_STATE=$(gh api repos/${{ github.repository }}/actions/workflows/${{ env.MAIN_WORKFLOW_FILE }} --jq '.state' 2>/dev/null || echo "not_found")

        echo "ì›Œí¬í”Œë¡œìš° ìƒíƒœ: $WORKFLOW_STATE"
        echo "workflow_state=$WORKFLOW_STATE" >> $GITHUB_OUTPUT

        # ë§ˆì§€ë§‰ ì„±ê³µ ì‹¤í–‰ ì‹œê°„ í™•ì¸
        LAST_SUCCESS=$(gh api "repos/${{ github.repository }}/actions/workflows/${{ env.MAIN_WORKFLOW_FILE }}/runs?status=success&per_page=1" --jq '.workflow_runs[0].created_at' 2>/dev/null || echo "never")
        echo "ë§ˆì§€ë§‰ ì„±ê³µ ì‹¤í–‰: $LAST_SUCCESS"
        echo "last_success=$LAST_SUCCESS" >> $GITHUB_OUTPUT

        # 24ì‹œê°„ ì´ë‚´ ì‹¤í–‰ í™•ì¸
        if [ "$LAST_SUCCESS" != "never" ] && [ "$LAST_SUCCESS" != "null" ]; then
          LAST_SUCCESS_EPOCH=$(date -d "$LAST_SUCCESS" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$LAST_SUCCESS" +%s 2>/dev/null || echo "0")
          NOW_EPOCH=$(date +%s)
          DIFF_HOURS=$(( (NOW_EPOCH - LAST_SUCCESS_EPOCH) / 3600 ))
          echo "ë§ˆì§€ë§‰ ì„±ê³µ í›„ ê²½ê³¼ ì‹œê°„: ${DIFF_HOURS}ì‹œê°„"
          echo "hours_since_success=$DIFF_HOURS" >> $GITHUB_OUTPUT
        else
          echo "hours_since_success=999" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ”„ Auto-Enable Workflow if Disabled
      if: steps.check_status.outputs.workflow_state == 'disabled_manually' || steps.check_status.outputs.workflow_state == 'disabled_inactivity'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "âš ï¸ ì›Œí¬í”Œë¡œìš°ê°€ ë¹„í™œì„±í™”ë¨! ìë™ í™œì„±í™” ì¤‘..."
        gh workflow enable ${{ env.MAIN_WORKFLOW_FILE }}
        echo "âœ… ì›Œí¬í”Œë¡œìš° í™œì„±í™” ì™„ë£Œ"

        # ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
        echo "ğŸš€ ì›Œí¬í”Œë¡œìš° ì¦‰ì‹œ ì‹¤í–‰..."
        gh workflow run ${{ env.MAIN_WORKFLOW_FILE }}
        echo "âœ… ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì™„ë£Œ"

    - name: ğŸ“§ Send Email Alert (ë¹„í™œì„±í™” ê°ì§€ ì‹œ)
      if: steps.check_status.outputs.workflow_state == 'disabled_manually' || steps.check_status.outputs.workflow_state == 'disabled_inactivity'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: mail.hsvina.com
        server_port: 587
        username: ${{ secrets.SMTP_USER }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "ğŸš¨ [V10 Dashboard] ì›Œí¬í”Œë¡œìš° ë¹„í™œì„±í™” ê°ì§€ ë° ìë™ ë³µêµ¬"
        to: ${{ env.ALERT_EMAIL }}
        from: V10 Dashboard Bot <${{ secrets.SMTP_USER }}>
        body: |
          âš ï¸ V10 Dashboard ìë™ ì—…ë°ì´íŠ¸ ì›Œí¬í”Œë¡œìš°ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆì—ˆìŠµë‹ˆë‹¤.

          ğŸ“Š ìƒíƒœ ì •ë³´:
          - ì›Œí¬í”Œë¡œìš°: ${{ env.MAIN_WORKFLOW_FILE }}
          - ì´ì „ ìƒíƒœ: ${{ steps.check_status.outputs.workflow_state }}
          - ê°ì§€ ì‹œê°„: ${{ github.event.head_commit.timestamp || 'N/A' }}

          âœ… ì¡°ì¹˜ ì‚¬í•­:
          - ì›Œí¬í”Œë¡œìš°ê°€ ìë™ìœ¼ë¡œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
          - ì›Œí¬í”Œë¡œìš°ê°€ ì¦‰ì‹œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.

          ğŸ”— í™•ì¸í•˜ê¸°:
          - Actions: https://github.com/${{ github.repository }}/actions
          - Dashboard: https://moonkaicuzui.github.io/hwk-qip-incentive-v10/

          ---
          ì´ ì•Œë¦¼ì€ V10 Workflow Watchdogì— ì˜í•´ ìë™ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.
      continue-on-error: true

    - name: ğŸ“§ Send Email Alert (24ì‹œê°„ ì´ìƒ ì‹¤í–‰ ì•ˆë¨)
      if: steps.check_status.outputs.hours_since_success > 24 && steps.check_status.outputs.workflow_state == 'active'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: mail.hsvina.com
        server_port: 587
        username: ${{ secrets.SMTP_USER }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "âš ï¸ [V10 Dashboard] ì›Œí¬í”Œë¡œìš° 24ì‹œê°„ ì´ìƒ ë¯¸ì‹¤í–‰"
        to: ${{ env.ALERT_EMAIL }}
        from: V10 Dashboard Bot <${{ secrets.SMTP_USER }}>
        body: |
          âš ï¸ V10 Dashboard ìë™ ì—…ë°ì´íŠ¸ ì›Œí¬í”Œë¡œìš°ê°€ 24ì‹œê°„ ì´ìƒ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

          ğŸ“Š ìƒíƒœ ì •ë³´:
          - ì›Œí¬í”Œë¡œìš° ìƒíƒœ: ${{ steps.check_status.outputs.workflow_state }}
          - ë§ˆì§€ë§‰ ì„±ê³µ ì‹¤í–‰: ${{ steps.check_status.outputs.last_success }}
          - ê²½ê³¼ ì‹œê°„: ${{ steps.check_status.outputs.hours_since_success }}ì‹œê°„

          ğŸ” í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤:
          - ì›Œí¬í”Œë¡œìš° ë¡œê·¸ í™•ì¸: https://github.com/${{ github.repository }}/actions
          - ìµœê·¼ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„ í•„ìš”

          ---
          ì´ ì•Œë¦¼ì€ V10 Workflow Watchdogì— ì˜í•´ ìë™ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.
      continue-on-error: true

    - name: ğŸ¥ Keep-Alive (60ì¼ ë¹„í™œì„±í™” ë°©ì§€)
      run: |
        echo "=== Keep-Alive: ë ˆí¬ì§€í† ë¦¬ í™œì„± ìƒíƒœ ìœ ì§€ ==="
        mkdir -p .github
        echo "ë§ˆì§€ë§‰ í™•ì¸: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > .github/last-watchdog-check.txt
        cat .github/last-watchdog-check.txt

    - name: ğŸ“ Commit Keep-Alive (ë³€ê²½ì‚¬í•­ ìˆì„ ë•Œë§Œ)
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # ë³€ê²½ì‚¬í•­ í™•ì¸
        if git diff --quiet .github/last-watchdog-check.txt 2>/dev/null; then
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì»¤ë°‹ ìŠ¤í‚µ"
        else
          git add .github/last-watchdog-check.txt
          git commit -m "ğŸ›¡ï¸ Watchdog: Keep-alive check $(date -u +"%Y-%m-%d")" || echo "Nothing to commit"
          git push || echo "Push failed - will retry next run"
        fi

    - name: ğŸ“§ Send Test Email (ìµœì´ˆ ì„¤ì • í™•ì¸ìš© - ìˆ˜ë™ ì‹¤í–‰ ì‹œì—ë§Œ)
      if: github.event_name == 'workflow_dispatch'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: mail.hsvina.com
        server_port: 587
        username: ${{ secrets.SMTP_USER }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "âœ… [V10 Dashboard] Watchdog ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ ì„±ê³µ"
        to: ${{ env.ALERT_EMAIL }}
        from: V10 Dashboard Bot <${{ secrets.SMTP_USER }}>
        body: |
          âœ… V10 Dashboard Watchdog ì´ë©”ì¼ ì•Œë¦¼ ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤!

          ğŸ“Š í˜„ì¬ ìƒíƒœ:
          - ë©”ì¸ ì›Œí¬í”Œë¡œìš°: ${{ steps.check_status.outputs.workflow_state }}
          - ë§ˆì§€ë§‰ ì„±ê³µ ì‹¤í–‰: ${{ steps.check_status.outputs.last_success }}
          - ê²½ê³¼ ì‹œê°„: ${{ steps.check_status.outputs.hours_since_success }}ì‹œê°„

          ğŸ”— í™•ì¸í•˜ê¸°:
          - Actions: https://github.com/${{ github.repository }}/actions
          - Dashboard: https://moonkaicuzui.github.io/hwk-qip-incentive-v10/

          ---
          ì´ í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ì€ ìˆ˜ë™ ì‹¤í–‰ ì‹œì—ë§Œ ë°œì†¡ë©ë‹ˆë‹¤.
      continue-on-error: true

    - name: âœ… Summary
      run: |
        echo "========================================"
        echo "ğŸ›¡ï¸ Workflow Watchdog ì‹¤í–‰ ì™„ë£Œ"
        echo "========================================"
        echo "ì›Œí¬í”Œë¡œìš° ìƒíƒœ: ${{ steps.check_status.outputs.workflow_state }}"
        echo "ë§ˆì§€ë§‰ ì„±ê³µ: ${{ steps.check_status.outputs.last_success }}"
        echo "ê²½ê³¼ ì‹œê°„: ${{ steps.check_status.outputs.hours_since_success }}ì‹œê°„"
        echo "========================================"
